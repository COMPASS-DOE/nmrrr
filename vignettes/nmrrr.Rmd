---
title: "Introduction to nmrrr"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{importing_data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r rmd-setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  message = FALSE,
  error = FALSE,
  comment = "#>"
)
```

```{r nmrrr-load, include=FALSE}
library(nmrrr)
```

This vignette represents the general workflow for processing NMR data using the *nmrrr* package. 

This package works only on processed data (e.g., phase-corrected, baseline-corrected, peak-picked, etc.). 
For tips on processing NMR data in MestreNova, check out the [repository wiki](https://github.com/kaizadp/nmrrr/wiki).

---

> **A note on the data used here**   
>
> This vignette uses data from the `kfp_hysteresis` dataset included with the `{nmrrr}` package. This is a subset of the data reported in [Patel et al. 2021](https://doi.org/10.1016/j.soilbio.2021.108165). Samples 27-30 represent Treatment A (flood+dried), and Samples 31-35 represent Treatment B (drought+rewet).  
These data were processed using MNova.  
More details can be found in the [repository wiki](https://github.com/kaizadp/nmrrr/wiki).


## Part 0. Setup

### Load additional packages

```{r packages}
library(tidyverse)
theme_set(theme_bw())
```

### Set input directories

```{r input-directories}
SPECTRA_FILES = "inst/extdata/kfp_hysteresis/spectra_mnova"
PEAKS_FILES = "inst/extdata/kfp_hysteresis/peaks_mnova_multiple"
```

---

## PART 1: Importing spectra files


`nmr_import_spectra`: 

This function will:

- import all the files from the SPECTRA_FILES location, 
- combine them into a single dataframe,
- and generate a dataframe with columns for ppm-shift, intensity, and sample-ID


```{r spectra-import}
spectra_df <- 
  nmr_import_spectra(path = SPECTRA_FILES,
                     method = "mnova") 


str(spectra_df)
```

Further cleaning of the dataframe must be done by the user, according to project-specific needs.

For instance, including only points between 0 and 10 ppm.

We want to keep only points between 0 and 10 ppm (user modification)
```{r spectra-process}
spectra_df  <-  
  spectra_df %>%
  filter(ppm >= 0 & ppm <= 10)

str(spectra_df)
```


---

## PART 2: Plotting the spectra


`nmr_plot_spectra`
This function will plot all the spectra present in the `spectra_df` file.

This is a basic ggplot format, and users can add additional customizations as needed

```{r spectra-plot}
nmr_plot_spectra(dat = spectra_df,
                 binset = bins_Clemente2012,
                 label_position = 5,
                 mapping = aes(x = ppm, y = intensity, group = sampleID, color = sampleID),
                 stagger = 0.5) +
  # OPTIONAL PARAMETERS/LAYERS
  geom_rect(aes(xmin = 2, xmax = 4, ymin = 0, ymax = 5.5), fill = "grey", color = NA, alpha = 0.6)+
  labs(subtitle = "binset: Clemente et al. 2012")+
  ylim(0, 5.5)
```


The compound classes (bins) are labelled in the graph. Adjust the position (y-axis) using `LABEL_POSITION = ...`.

Overlaid spectra can be staggered along the y-axis using `STAGGER - ...`.

This function makes use of `ggplot2` capabilities, and the plot can therefore be customized using `ggplot2` nomenclature.

---

## PART 3: Assigning compound classes 

```{r}
spectra_bins = nmr_assign_bins(dat = spectra_df,
                               binset = bins_Clemente2012)
```

---

## PART 4: Calculate relative abundance of compound classes

### Method 1: Integrating area under the curve from processed spectra files (`method = "AUC`)

```{r}
relabund_integration = nmr_relabund(dat = spectra_bins,
                                    method = "AUC")
```

### Method 2: Calculating from peaks data (`method = "peaks"`)

This method is specific to MNova-processed data. Users may pick peaks within MNova and export these as a table. In this case, users can simply add the area counts for each peak to calculate the relative contribution of the peak/bin type to the total area.

The peaks data can be exported one of two ways, giving two different formats of data files. This package can handle both versions. 
More details can be found in the [repository wiki](https://github.com/kaizadp/nmrrr/wiki).

For both types, however, we first need to import and combine the files, then assign bin classes, and then add the areas.

#### 2.1: Multiple columns

```{r}
peaks_df = nmr_import_peaks(path = PEAKS_FILES, method = "multiple columns")

str(peaks_df)
```

The columns we care about the most are `ppm` and `Area`.
There are additional columns that provide flags for the peaks identified (e.g. `Type == "Artifact"/"Compound"/"Solvent"`, `Flags = "Weak"/"None"`, etc.).
These can be filtered by the user as needed.

```{r}
peaks_bins = nmr_assign_bins(dat = peaks_df,
                             binset = bins_Clemente2012)
```

```{r}
relabund_bins = nmr_relabund(dat = peaks_bins,
                             method = "peaks")
```


---

## PART 3: Processing peaks data

When exporting peaks data from MestreNova, the data are generally split across multiple columns.

The `import_nmr_peaks()` function will import the files in that format and then collapse all the columns for a single long-form dataframe.

```{r}
hyst_peaks_processed_mult = nmr_import_peaks(path = PEAKS_FILES, method = "multiple columns")

head(hyst_peaks_processed_mult)

```

```{r}
hyst_peaks_processed_mult_bins = nmr_assign_bins(dat = hyst_peaks_processed_mult, binset = bins_Clemente2012)

```


**Note: The user may want to assign additional filtering steps to filter certain flagged data points, e.g. impurities, weak peaks, etc. ** 

For this current dataset, because of the strong influence of water peaks in the o-alkyl region, we exclude that region from our calculations.

```{r}
peaks_processed2 = 
  hyst_peaks_processed_mult_bins %>% 
  filter(group != "oalkyl")
```


---

## PART V: Exporting the processed data

The processed dataframes generated here can be exported using the usual R export functions, e.g. `write.csv()`, `write.table()`, etc.  


---

<details>
<summary>Session Info - click to open</summary>

Date run: `r Sys.Date()`


```{r, echo=FALSE}
sessionInfo()
```

</details>

---
